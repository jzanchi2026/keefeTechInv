<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Class Management Dashboard</title>
    <link href="classStyle.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/x-icon" href="images/Logo.png">
    <!-- Google Fonts for Oswald -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  </head>
    <!--jimmy-->
  <body>
    <nav>
    <!--KTI Logo and Title-->
    <p class="navMainText">
      <img id="navImage" src="Images/newlogo.png" width="100" alt="drawing of a welder">
      Keefe Tech Inventory - classes
    </p>

    <br>
    <!--Jimmy-->
    <!--Navigation Bar-->
    <div class="topnav" id="myTopnav">
      <a href="../keefeTechInv/itemlist.html"><b><i>Items</a></b></i>
      <a href="javascript:void(0);" class="icon" onclick="myFunction()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
      
  </nav>

    <main style="margin-top:64px;">
      <div id="addClass">
        <label for="cName">Class Name</label><br>
        <input type="text" id="cName" name="cName" placeholder="Enter new class name"><br>
        <button onclick="addClass()">Add Class</button>
      </div>

      <div id="addStudents" style="margin-top:32px;">
        <h3>Add Student to Class</h3>
        <label for="sClass">Class</label><br>
        <select id="sClass" name="sClass"></select><br>
        <div id="userList" style="margin-top:18px;"></div>
      </div>

      <div style="margin-top:40px;">
        <h3>Classrooms & Students</h3>
        <div id="classrooms"></div>
      </div>
    </main>

    <script>
      // Store classes and students in memory
      const classes = [];
      const studentsByClass = {};
      const StudentId = [];

      // Store students that have already been assigned to a class
const assignedStudentIds = new Set();

// Add a new class
      async function addClass() {
  const cName = document.getElementById("cName").value.trim();
  if (!cName) {
    alert("Please enter a class name.");
    return;
  }
  // Send POST request to create class in the database
  try {
    const response = await fetch("https://develmets.skiscratcher.com/createClass", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ name: cName }),
      credentials: "include"
    });
    if (!response.ok) {
      alert("Failed to create class.");
      return;
    }
    document.getElementById("cName").value = "";
    await fetchAndRenderClasses(); // Update the UI with new classes from the database
  } catch (err) {
    alert("Error creating class: " + err);
  }
}

      // Fetch classes from the database and update dropdown and classroom list
      async function fetchAndRenderClasses() {
  try {
    const response = await fetch("https://develmets.skiscratcher.com/getClasses", {
      method: "GET",
      credentials: "include"
    });
    if (!response.ok) {
      alert("Failed to fetch classes.");
      return;
    }
    const classList = await response.json();
    // Update local classes and studentsByClass
    classes.length = 0;
    classList.forEach(cls => {
      classes.push({ className: cls.className, id: cls.id });
      if (!studentsByClass[cls.id]) studentsByClass[cls.id] = [];
    });
    updateClassDropdown();
    await fetchAssignedStudents();
    renderClassrooms();
    renderUserList();
  } catch (err) {
    alert("Error fetching classes: " + err);
  }
}

// Update the class dropdown in the Add Student form
      function updateClassDropdown() {
        const sClassSelect = document.getElementById("sClass");
        sClassSelect.innerHTML = "";
        classes.forEach(cls => {
          const option = document.createElement("option");
          option.value = cls.className;
          option.textContent = cls.className;
          sClassSelect.appendChild(option);
        });
      }

      // Add a student to the selected class
      function addStudent() {
        const sName = document.getElementById("sName").value.trim();
        const sEmail = document.getElementById("sEmail").value.trim();
        const sClass = document.getElementById("sClass").value;
        if (!sName || !sEmail || !sClass) {
          alert("Please fill in all fields.");
          return;
        }
        studentsByClass[sClass].push({ name: sName, email: sEmail });
        document.getElementById("sName").value = "";
        document.getElementById("sEmail").value = "";
        renderClassrooms();
      }

// Add student to class and persist to backend
async function addStudentToClass(user, classId) {
  try {
    const response = await fetch("https://develmets.skiscratcher.com/assignStudentToClass", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ studentId: user.userid, classId: classId }),
      credentials: "include"
    });

    if (!response.ok) {
      alert("Failed to assign student to class.");
      return;
    }

    assignedStudentIds.add(user.id);
    if (!studentsByClass[classId]) studentsByClass[classId] = [];
    studentsByClass[classId].push({ name: user.displayName, email: user.email, id: user.userid });
    renderClassrooms();
    renderUserList();

  } catch (err) {
    alert("Error assigning student: " + err);
  }
}


// Fetch assigned students for each class from backend
async function fetchAssignedStudents() {
  try {
    const response = await fetch("https://develmets.skiscratcher.com/users", {
      method: "GET",
      credentials: "include"
    });
    if (!response.ok) return;
    const assigned = await response.json();
    assigned.forEach(item => {
      assignedStudentIds.add(item.userid);
      if (!studentsByClass[item.classId]) studentsByClass[item.classId] = [];
      studentsByClass[item.classId].push({ name: item.displayName, email: item.email, id: item.userid });
    });
  } catch (err) {
    // Ignore errors for now
  }
}
let classIdToName = {};
// Fetch users and display them with add buttons (excluding already assigned students)
// Fetch users and display them with add buttons (excluding already assigned students)
async function renderUserList() {
  const userListDiv = document.getElementById("userList");
  userListDiv.innerHTML = "<b>Loading users...</b>";
  try {
    const response = await fetch("https://develmets.skiscratcher.com/users", {
      method: "GET",
      credentials: "include"
    });
    if (!response.ok) {
      userListDiv.innerHTML = "<b>Failed to fetch users.</b>";
      return;
    }

    const users = await response.json();

    // Filter out admins and already assigned students
    const filtered = users.filter(user => user.userType == 1 && !assignedStudentIds.has(user.id));

    if (filtered.length === 0) {
      userListDiv.innerHTML = "<b>No students available to add.</b>";
      return;
    }

    userListDiv.innerHTML = "";

    filtered.forEach(user => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.marginBottom = "8px";

      // Add button
      const addBtn = document.createElement("button");
      addBtn.textContent = "+";
      addBtn.style.marginRight = "12px";
      addBtn.onclick = function () {
        const sClass = document.getElementById("sClass").value;
        const classObj = classes.find(cls => cls.className === sClass);
        if (!classObj) {
          alert("Please select a class first.");
          return;
        }
        addStudentToClass(user, classObj.id);
      };
      row.appendChild(addBtn);

      // Student info with class name
      const info = document.createElement("span");
      const className = classIdToName[user.classId] || "No class assigned";
      info.textContent = `${user.displayName} (${user.email}) â€“ Class: ${className}`;
      row.appendChild(info);

      userListDiv.appendChild(row);
    });
  } catch (err) {
    userListDiv.innerHTML = "<b>Error loading users.</b>";
  }
}

// Render all classrooms and their students
function renderClassrooms() {
  const container = document.getElementById("classrooms");
  container.innerHTML = "";
  classes.forEach(cls => {
    const classDiv = document.createElement("div");
    classDiv.className = "classroom-block";
    classDiv.style.marginBottom = "32px";
    classDiv.innerHTML = `<h4 style="color:#d32f2f;">${cls.className}</h4>`;
    const table = document.createElement("table");
    table.className = "classTable";
    table.style.width = "100%";
    table.innerHTML = `
      <tr>
        <th>Student Name</th>
        <th>Email</th>
        <th>Checked Out Tools</th>
      </tr>
    `;
    (studentsByClass[cls.id] || []).forEach(student => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${student.name}</td><td>${student.email}</td><td></td>`;
      table.appendChild(row);
    });
    classDiv.appendChild(table);
    container.appendChild(classDiv);
  });
}

// Initialize dropdown and fetch classes/students on page load
window.addEventListener("DOMContentLoaded", fetchAndRenderClasses);

// Also call renderUserList when the class dropdown changes
document.getElementById("sClass").addEventListener("change", renderUserList);
    </script>
  </body>
</html>